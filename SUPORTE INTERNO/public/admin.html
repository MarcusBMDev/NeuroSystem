<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel TI - NeuroCenter</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #141E30; /* Azul Escuro Institucional */
            --secondary: #243B55;
            --bg-color: #f4f6f9;
            --text-color: #333;
            --card-bg: #ffffff;
        }
        
        body { font-family: 'Montserrat', sans-serif; background: var(--bg-color); margin: 0; padding: 0; color: var(--text-color); }

        /* Barra de Alerta (Substitui a tela piscando) */
        .alert-bar {
            display: none; background: #c62828; color: white; text-align: center; padding: 10px;
            font-weight: bold; animation: pulseRed 1s infinite;
        }
        @keyframes pulseRed { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        h1 { margin: 0; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }

        .header-actions { display: flex; gap: 15px; }
        .btn-header {
            text-decoration: none; padding: 8px 15px; border-radius: 6px; font-size: 0.85rem; font-weight: 600;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn-excel { background: #217346; color: white; }
        .btn-excel:hover { background: #1a5c38; }
        
        .btn-voltar { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-voltar:hover { background: rgba(255,255,255,0.3); }

        .dashboard-container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        /* Contadores R√°pidos */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center; border-bottom: 4px solid #ddd;
        }
        .stat-number { font-size: 2rem; font-weight: 700; color: var(--primary); display: block; }
        .stat-label { font-size: 0.9rem; color: #777; font-weight: 600; text-transform: uppercase; }

        .painel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .coluna { background: transparent; }
        
        h2 { 
            font-size: 1.1rem; color: var(--secondary); border-bottom: 2px solid #ddd; 
            padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;
        }
        
        .ticket-card {
            background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05); border-left: 5px solid #ccc;
            position: relative; transition: transform 0.2s;
        }
        .ticket-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .ticket-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.85rem; color: #666; }
        .ticket-title { font-weight: 700; font-size: 1.05rem; color: #333; margin-bottom: 5px; }
        .ticket-desc { color: #555; line-height: 1.5; font-size: 0.95rem; }
        .ticket-meta { margin-top: 10px; font-size: 0.85rem; color: #888; background: #f8f9fa; padding: 8px; border-radius: 6px; }

        /* Status Cores */
        .ticket-em-andamento { background-color: #fffde7; border-color: #ffc107; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .badge-andamento { background: #ffc107; color: #333; }

        /* Bot√µes */
        .btn-action { width: 100%; border: none; padding: 12px; border-radius: 8px; margin-top: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; font-family: inherit; }
        .btn-aceitar { background: #0056b3; color: white; }
        .btn-aceitar:hover { background: #004494; }
        .btn-concluir { background: #2e7d32; color: white; }
        .btn-concluir:hover { background: #1b5e20; }

        /* Hist√≥rico */
        .historico-card { opacity: 0.85; border-left-color: #555; }
        .resolucao-box { background: #e8f5e9; color: #1b5e20; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.9rem; border: 1px solid #c8e6c9; }

        @media (max-width: 900px) { .painel-grid { grid-template-columns: 1fr; } .stats-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body id="corpoPagina">

    <div id="alertaBar" class="alert-bar">üî• NOVO CHAMADO DE SUPORTE ABERTO! üî•</div>

    <header>
        <h1>üõ°Ô∏è Painel TI <small style="font-size:0.5em; opacity:0.7; font-weight:400; margin-left:10px">v2.0</small></h1>
        <div class="header-actions">
            <button onclick="ativarNotificacoes()" id="btnNotif" class="btn-header" style="background:#e65100; color:white; border:none; cursor:pointer;">üîî Ativar Alertas</button>
            <a href="/api/exportar" class="btn-header btn-excel">üìä Exportar Excel</a>
            <a href="http://192.168.10.133" class="btn-header btn-voltar">üè† Voltar ao Portal</a>
        </div>
    </header>

    <div class="dashboard-container">
        
        <div class="stats-row">
            <div class="stat-card" style="border-bottom-color: #c62828;">
                <span id="stat-abertos" class="stat-number">0</span>
                <span class="stat-label">Fila de Espera</span>
            </div>
            <div class="stat-card" style="border-bottom-color: #ffc107;">
                <span id="stat-andamento" class="stat-number">0</span>
                <span class="stat-label">Em Atendimento</span>
            </div>
            <div class="stat-card" style="border-bottom-color: #2e7d32;">
                <span id="stat-concluidos" class="stat-number">0</span>
                <span class="stat-label">Resolvidos (Total)</span>
            </div>
        </div>

        <div class="painel-grid">
            <div class="coluna">
                <h2>üî• Fila de Atendimento</h2>
                <div id="listaAbertos">
                    <p style="text-align:center; color:#999; margin-top:20px;">Carregando chamados...</p>
                </div>
            </div>

            <div class="coluna">
                <h2>‚úÖ √öltimos Conclu√≠dos</h2>
                <div id="listaHistorico">
                    <p style="text-align:center; color:#999;">Carregando hist√≥rico...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let totalAnterior = -1;

        document.addEventListener('DOMContentLoaded', () => {
            carregarTudo(); 
            setInterval(carregarTudo, 2000);
            if (Notification.permission === "granted") document.getElementById('btnNotif').style.display = 'none';
        });

        function ativarNotificacoes() {
            Notification.requestPermission().then(p => { 
                if (p === "granted") { 
                    alert("Notifica√ß√µes ativadas!"); 
                    document.getElementById('btnNotif').style.display = 'none'; 
                }
            });
        }

        async function carregarTudo() {
            try {
                const res = await fetch('/api/chamados'); 
                const todos = await res.json();
                
                const divAbertos = document.getElementById('listaAbertos');
                const divHist = document.getElementById('listaHistorico');
                
                // Filtros
                const abertos = todos.filter(c => c.status === 'aberto');
                const andamento = todos.filter(c => c.status === 'andamento');
                const concluidos = todos.filter(c => c.status === 'concluido');
                const ativos = [...abertos, ...andamento]; // Junta para exibir na esquerda

                // Atualiza Contadores
                document.getElementById('stat-abertos').innerText = abertos.length;
                document.getElementById('stat-andamento').innerText = andamento.length;
                document.getElementById('stat-concluidos').innerText = concluidos.length;

                // L√≥gica do Alerta Sonoro/Visual
                const countAbertos = abertos.length;
                if (totalAnterior !== -1 && countAbertos > totalAnterior) {
                    dispararAlerta();
                }
                totalAnterior = countAbertos;
                
                // Atualiza T√≠tulo da Aba
                if (countAbertos > 0) {
                    document.title = `(${countAbertos}) üî• CHAMADO PENDENTE`;
                    document.getElementById('alertaBar').style.display = 'block';
                } else {
                    document.title = "Painel TI - NeuroCenter";
                    document.getElementById('alertaBar').style.display = 'none';
                }

                divAbertos.innerHTML = ''; 
                divHist.innerHTML = '';

                // Ordena√ß√£o por Urg√™ncia
                const pri = { 'critica': 1, 'alta': 2, 'media': 3, 'baixa': 4 };
                ativos.sort((a, b) => {
                    // Primeiro prioriza quem j√° est√° em atendimento
                    if (a.status === 'andamento' && b.status !== 'andamento') return -1;
                    if (b.status === 'andamento' && a.status !== 'andamento') return 1;
                    return pri[a.urgencia] - pri[b.urgencia];
                });

                if (ativos.length === 0) {
                    divAbertos.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">
                        <span style="font-size:3rem; display:block; margin-bottom:10px;">‚òï</span>
                        Tudo tranquilo por aqui.
                    </div>`;
                }

                ativos.forEach(c => {
                    let cor = definirCor(c.urgencia);
                    let botaoHtml = '';
                    let classeExtra = '';
                    let badge = '';

                    if (c.status === 'aberto') {
                        botaoHtml = `<button class="btn-action btn-aceitar" onclick="aceitar(${c.id})">üèÉ‚Äç‚ôÇÔ∏è INICIAR ATENDIMENTO</button>`;
                    } else if (c.status === 'andamento') {
                        botaoHtml = `<button class="btn-action btn-concluir" onclick="concluir(${c.id})">‚úÖ CONCLUIR CHAMADO</button>`;
                        classeExtra = 'ticket-em-andamento';
                        badge = '<span class="badge badge-andamento">‚ö° EM ATENDIMENTO</span>';
                    }

                    divAbertos.innerHTML += `
                        <div class="ticket-card ${classeExtra}" style="border-left-color: ${cor}">
                            <div class="ticket-header">
                                <span>#${c.id} ‚Ä¢ ${c.data_abertura}</span>
                                ${badge}
                            </div>
                            <div class="ticket-title">${c.solicitante} <span style="font-weight:400; font-size:0.9rem; color:#777;">(${c.setor})</span></div>
                            <div class="ticket-desc">${c.descricao}</div>
                            
                            ${c.testes_realizados ? `<div class="ticket-meta"><strong>Testes:</strong> ${c.testes_realizados}</div>` : ''}
                            
                            ${botaoHtml}
                        </div>`;
                });

                concluidos.reverse().slice(0, 10).forEach(c => { // Mostra s√≥ os ultimos 10
                    divHist.innerHTML += `
                        <div class="ticket-card historico-card">
                            <div class="ticket-header">
                                <span>#${c.id} ‚Ä¢ Fechado em: ${c.data_fechamento}</span>
                                <span style="color:#2e7d32; font-weight:bold;">‚úî Conclu√≠do</span>
                            </div>
                            <div class="ticket-title">${c.solicitante}</div>
                            <div class="resolucao-box"><strong>Solu√ß√£o:</strong> ${c.resolucao || '-'}</div>
                        </div>`;
                });

            } catch (e) { console.error(e); }
        }

        async function aceitar(id) {
            await fetch(`/api/chamados/${id}/aceitar`, { method: 'PUT' });
        }

        async function concluir(id) {
            let resolucao = prompt("Descreva o que foi feito para resolver:");
            if (resolucao !== null) {
                if(resolucao === "") resolucao = "Resolvido presencialmente.";
                await fetch(`/api/chamados/${id}/concluir`, { 
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ resolucao: resolucao })
                });
            }
        }

        function dispararAlerta() {
            if (Notification.permission === "granted") new Notification("üî¥ NOVO CHAMADO TI!", { body: "Um novo ticket foi aberto no HelpDesk." });
            // Toca um som curto se quiser (opcional)
            // let audio = new Audio('alert.mp3'); audio.play().catch(e=>{});
        }

        function definirCor(u) { const m={'baixa':'#28a745','media':'#17a2b8','alta':'#fd7e14','critica':'#dc3545'}; return m[u]||'#ccc'; }
    </script>
</body>
</html>