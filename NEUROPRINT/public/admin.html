<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel de Gest√£o - NeuroPrint</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilo extra para caber mais informa√ß√£o */
        table { font-size: 0.9rem; }
        .info-sub { font-size: 0.8rem; color: #666; display: block; }
        .obs-text { font-style: italic; color: #555; background: #fff8e1; padding: 2px 5px; border-radius: 4px; font-size: 0.8rem; }
        .deadline-badge { color: #dc3545; font-weight: bold; background: #fff5f5; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container-wide">
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div class="card" style="flex: 1; padding: 15px;">
                <h4>üìä Pedidos por Setor</h4>
                <canvas id="chartSetor" style="max-height: 200px;"></canvas>
            </div>
            <div class="card" style="flex: 1; padding: 15px;">
                <h4>üèÜ Top Solicitantes</h4>
                <canvas id="chartUsuario" style="max-height: 200px;"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="dashboard-header">
                <div>
                    <h2><i class="fa-solid fa-print"></i> Fila de Impress√£o</h2>
                    <span class="subtitle" id="adminName">...</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="secondary refresh-btn" style="background-color: #198754;" onclick="baixarExcel()">
                        <i class="fa-solid fa-file-excel"></i> Excel
                    </button>
                    <button class="refresh-btn" onclick="carregarTudo()">
                        <i class="fa-solid fa-sync"></i> Atualizar
                    </button>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th width="5%">ID</th>
                        <th width="15%">Solicitante</th>
                        <th width="20%">Arquivos</th>
                        <th width="15%">Configura√ß√£o</th>
                        <th width="15%">Prazos</th>
                        <th width="15%">Observa√ß√£o</th>
                        <th width="10%">Status/A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="tabelaPedidos"></tbody>
            </table>
        </div>
    </div>

    <script>
        const userData = JSON.parse(localStorage.getItem('neuroUser'));
        if (!userData || !userData.isAdmin) window.location.href = 'index.html';
        document.getElementById('adminName').innerText = `Gestor: ${userData.username}`;

        async function carregarTudo() {
            carregarPedidos();
            carregarGraficos();
        }

        async function carregarPedidos() {
            try {
                const res = await fetch('/api/print/jobs', { headers: { 'user-id': userData.id } });
                const lista = await res.json();
                const tbody = document.getElementById('tabelaPedidos');
                tbody.innerHTML = '';

                lista.forEach(job => {
                    const tr = document.createElement('tr');
                    if (job.is_urgent) tr.classList.add('urgent-row');

                    // 1. ARQUIVOS
                    const nomes = job.file_name.split(';');
                    const caminhos = job.file_path.split(';');
                    let htmlArquivos = '';
                    nomes.forEach((nome, index) => {
                        let pathRaw = caminhos[index] || '';
                        let cleanFilename = pathRaw.includes('\\') ? pathRaw.split('\\').pop() : pathRaw;
                        htmlArquivos += `<a href="/files/${cleanFilename}" target="_blank" style="display:block; text-decoration:none; color:#d9534f; margin-bottom:2px;"><i class="fa-solid fa-file-pdf"></i> ${nome.trim()}</a>`;
                    });

                    // 2. DATAS (Solicita√ß√£o e Prazo)
                    const dataCriacao = new Date(job.created_at).toLocaleDateString('pt-BR');
                    let prazoHtml = `<span class="info-sub">Criado: ${dataCriacao}</span>`;
                    
                    if (job.deadline) {
                        const dataPrazo = new Date(job.deadline);
                        const dataFormatada = dataPrazo.toLocaleDateString('pt-BR') + ' ' + dataPrazo.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                        prazoHtml += `<br><span class="deadline-badge">‚ö†Ô∏è Para: ${dataFormatada}</span>`;
                    }

                    // 3. STATUS & BOT√ïES
                    let statusClass = 'pendente';
                    let statusLabel = 'Pendente';
                    let botao = '';

                    if (job.status === 'em_andamento') { statusClass = 'em_andamento'; statusLabel = 'Imprimindo'; }
                    if (job.status === 'impresso') { statusClass = 'impresso'; statusLabel = 'Conclu√≠do'; }

                    if (job.status === 'pendente' || !job.status) {
                        botao = `<button class="btn-action" style="background:#0d6efd; color:white; border:none; margin-top:5px; cursor:pointer;" onclick="atualizarStatus(${job.id}, 'em_andamento')">‚ñ∂ Iniciar</button>`;
                    } else if (job.status === 'em_andamento') {
                        botao = `<button class="btn-action" style="background:#198754; color:white; border:none; margin-top:5px; cursor:pointer;" onclick="atualizarStatus(${job.id}, 'impresso')">‚úî Concluir</button>`;
                    }

                    // 4. OBSERVACAO
                    const obsHtml = job.observacao ? `<div class="obs-text">"${job.observacao}"</div>` : '<span style="color:#ccc;">-</span>';

                    tr.innerHTML = `
                        <td>#${job.id}</td>
                        <td><b>${job.solicitante}</b><br><small>${job.setor}</small></td>
                        <td>${htmlArquivos}</td>
                        <td>
                            <b>${job.copies}x</b> (${job.color_mode})<br>
                            <small>P√°gs: ${job.page_range}</small><br>
                            ${job.is_urgent ? '<span style="color:red; font-weight:bold;">üî• URGENTE</span>' : ''}
                        </td>
                        <td>${prazoHtml}</td>
                        <td>${obsHtml}</td>
                        <td style="text-align:center;">
                            <span class="status-tag status-${statusClass}">${statusLabel}</span><br>
                            ${botao}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) { console.error("Erro ao carregar tabela:", err); }
        }

        async function atualizarStatus(id, novoStatus) {
            try {
                const res = await fetch(`/api/print/jobs/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'user-id': userData.id },
                    body: JSON.stringify({ status: novoStatus })
                });
                
                if(res.ok) {
                    carregarPedidos(); // Recarrega se der certo
                } else {
                    const err = await res.json();
                    alert('Erro: ' + (err.error || 'Falha ao atualizar'));
                }
            } catch(e) { 
                console.error(e); 
                alert('Erro de conex√£o ao tentar atualizar status.');
            }
        }

        // Gr√°ficos (C√≥digo mantido igual para economizar espa√ßo, se precisar eu reenvio)
        let chart1, chart2;
        async function carregarGraficos() {
             try {
                const res = await fetch('/api/print/stats', { headers: { 'user-id': userData.id } });
                const data = await res.json();
                const ctx1 = document.getElementById('chartSetor').getContext('2d');
                if(chart1) chart1.destroy();
                chart1 = new Chart(ctx1, { type: 'doughnut', data: { labels: data.porSetor.map(d => d.label), datasets: [{ data: data.porSetor.map(d => d.total), backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545'] }] } });
                const ctx2 = document.getElementById('chartUsuario').getContext('2d');
                if(chart2) chart2.destroy();
                chart2 = new Chart(ctx2, { type: 'bar', data: { labels: data.porUsuario.map(d => d.label), datasets: [{ label: 'Total', data: data.porUsuario.map(d => d.total), backgroundColor: '#0d6efd' }] } });
            } catch(e) {}
        }
        
        async function baixarExcel() {
            const res = await fetch('/api/print/report', { headers: { 'user-id': userData.id } });
            if(res.ok) {
                const blob = await res.blob();
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = `Relatorio_${new Date().toISOString().slice(0,10)}.xlsx`;
                link.click();
            }
        }

        carregarTudo();
        setInterval(carregarTudo, 30000);
    </script>
</body>
</html>